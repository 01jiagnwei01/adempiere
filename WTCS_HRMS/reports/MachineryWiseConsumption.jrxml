<?xml version="1.0" encoding="UTF-8"?>
<!-- $Id: MachineryWiseConsumption.jrxml 1009 2012-02-09 09:16:13Z suman $ --> 
 <jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="MachineryWiseConsumption" pageWidth="700" pageHeight="842" whenNoDataType="NoDataSection" columnWidth="640" leftMargin="30" rightMargin="30" topMargin="20" bottomMargin="20">
	<property name="ireport.scriptlethandling" value="0"/>
	<property name="ireport.encoding" value="UTF-8"/>
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<import value="net.sf.jasperreports.engine.*"/>
	<import value="java.util.*"/>
	<import value="net.sf.jasperreports.engine.data.*"/>
	<parameter name="WTC_REPORT_NAME" class="java.lang.String" isForPrompting="false">
		<parameterDescription><![CDATA[Report name]]></parameterDescription>
		<defaultValueExpression><![CDATA["Sample Report Title"]]></defaultValueExpression>
	</parameter>
	<parameter name="FromDate" class="java.sql.Timestamp">
		<defaultValueExpression><![CDATA[new Date()]]></defaultValueExpression>
	</parameter>
	<parameter name="ToDate" class="java.sql.Timestamp">
		<defaultValueExpression><![CDATA[new Date()]]></defaultValueExpression>
	</parameter>
	<parameter name="S_Resource_ID" class="java.math.BigDecimal">
		<defaultValueExpression><![CDATA[new BigDecimal(0)]]></defaultValueExpression>
	</parameter>
	<parameter name="SUBREPORT_DIR" class="java.lang.String">
		<defaultValueExpression><![CDATA["./"]]></defaultValueExpression>
	</parameter>
	<parameter name="AD_Org_ID" class="java.math.BigDecimal"/>
	<parameter name="C_AcctSchema_ID" class="java.math.BigDecimal"/>
	<queryString>
		<![CDATA[SELECT  DISTINCT resou.S_Resource_ID ,
        resou.name AS MachinName ,
        SUM(base.issuedQuantity ) AS issuedQty,
        SUM(base.Issuedamount ) AS amount
  FROM  S_Resource resou

  JOIN
        (
          SELECT  --DISTINCT COALESCE( rs.name,'') AS MachinName ,
              rs.S_Resource_ID ,
              COALESCE((SELECT SUM(COALESCE(mcd1.Qty,0))/( SELECT    COUNT(DISTINCT (mcd11.M_CostElement_ID ))
                                                             FROM M_CostDetail mcd11
                                                             WHERE  (mcd11.dateacct BETWEEN '$P!{FromDate}' and '$P!{ToDate}' )
                                                             AND  mcd11.M_InventoryLine_ID = cd.M_InventoryLine_ID
                                                             AND (pro.M_Product_ID=mcd11.M_Product_ID )
                                                             AND (mcd11.C_AcctSchema_ID = $P{C_AcctSchema_ID})
                                                             AND mcd11.M_Costtype_ID=(SELECT M_Costtype_ID FROM  C_AcctSchema WHERE C_AcctSchema_ID = $P{C_AcctSchema_ID} )
                                                             AND mcd11.costingmethod=(SELECT costingmethod FROM  C_AcctSchema WHERE C_AcctSchema_ID = $P{C_AcctSchema_ID} )
                                                          )
                        FROM M_CostDetail mcd1
                        WHERE (mcd1.dateacct BETWEEN '$P!{FromDate}' and '$P!{ToDate}' )
                        AND  mcd1.M_InventoryLine_ID = cd.M_InventoryLine_ID
                        AND  (pro.M_Product_ID=mcd1.M_Product_ID )
                        AND (mcd1.C_AcctSchema_ID = $P{C_AcctSchema_ID})
                        AND mcd1.M_Costtype_ID=(SELECT M_Costtype_ID FROM  C_AcctSchema WHERE C_AcctSchema_ID = $P{C_AcctSchema_ID} )
                        AND mcd1.costingmethod=(SELECT costingmethod FROM  C_AcctSchema WHERE C_AcctSchema_ID = $P{C_AcctSchema_ID} )  )
                 ,0   )  AS issuedQuantity  ,
              COALESCE((SELECT SUM(COALESCE(mcd2.Amt,0)) from M_CostDetail mcd2
                                                 WHERE  (mcd2.dateacct  BETWEEN '$P!{FromDate}' and '$P!{ToDate}' )
                                                 AND (pro.M_Product_ID=mcd2.M_Product_ID )
                                                 AND mcd2.M_InventoryLine_ID = cd.M_InventoryLine_ID
                                                 AND (mcd2.C_AcctSchema_ID = $P{C_AcctSchema_ID})
                                                 AND mcd2.M_Costtype_ID=(SELECT M_Costtype_ID FROM  C_AcctSchema WHERE C_AcctSchema_ID = $P{C_AcctSchema_ID} )
                                                 AND mcd2.costingmethod=(SELECT costingmethod FROM  C_AcctSchema WHERE C_AcctSchema_ID = $P{C_AcctSchema_ID} )
              ),0) AS Issuedamount
          FROM M_Product pro
          JOIN M_CostDetail cd ON  cd.M_Product_ID=pro.M_Product_ID
          JOIN M_InventoryLine minl ON  minl.M_InventoryLine_ID = cd.M_InventoryLIne_ID
          JOIN M_Inventory mi ON mi.M_Inventory_Id=minl.M_INventory_ID
          JOIN S_Resource rs ON rs.S_Resource_ID=mi.S_Resource_ID

          Where
           ( CASE WHEN $P{S_Resource_ID}=0 THEN 1=1 ELSE rs.S_Resource_ID=$P{S_Resource_ID} END )
         -- AND rs.S_Resource_ID = resou.S_Resource_ID
          AND ( CAST(mi.movementdate as date) between CAST('$P!{FromDate}'as date)  and CAST('$P!{ToDate}'as date) )
          AND (cd.dateacct BETWEEN '$P!{FromDate}' and '$P!{ToDate}' )
          AND mi.movementtype IN ('I-','I+')
          AND mi.DocStatus IN ('CO','CL')
          AND (cd.C_AcctSchema_ID = $P{C_AcctSchema_ID})
          AND cd.M_Costtype_ID=(SELECT M_Costtype_ID FROM  C_AcctSchema WHERE C_AcctSchema_ID = $P{C_AcctSchema_ID} )
          AND cd.costingmethod=(SELECT costingmethod FROM  C_AcctSchema WHERE C_AcctSchema_ID = $P{C_AcctSchema_ID} )

        Group By  rs.S_Resource_ID, cd.M_InventoryLine_ID ,pro.M_Product_ID --,MachinName, minl.M_InventoryLine_ID
      --  Order By  MachinName

       ) base  ON resou.S_Resource_ID=base.S_Resource_ID

WHERE  ( CASE WHEN $P{S_Resource_ID}=0 THEN 1=1 ELSE resou.S_Resource_ID=$P{S_Resource_ID} END )
AND EXISTS(select minv.S_Resource_ID
             FROM M_Inventory minv
             WHERE ( minv.movementdate BETWEEN '$P!{FromDate}' and '$P!{ToDate}')
              AND minv.movementtype IN ('I-','I+')
              AND minv.DocStatus IN ('CO','CL')
          )
Group By resou.S_Resource_ID , resou.name ]]>
	</queryString>
	<field name="machinname" class="java.lang.String"/>
	<field name="issuedqty" class="java.math.BigDecimal"/>
	<field name="amount" class="java.math.BigDecimal"/>
	<variable name="currentDate" class="java.lang.String">
		<variableExpression><![CDATA[(new SimpleDateFormat("dd/MM/yyyy")).format(new Date())]]></variableExpression>
	</variable>
	<variable name="currentDateTime" class="java.lang.String">
		<variableExpression><![CDATA[(new SimpleDateFormat("dd/MM/yyyy hh:mm:ss aaa z")).format(new Date())]]></variableExpression>
	</variable>
	<variable name="noData" class="java.lang.String">
		<variableExpression><![CDATA["Data Not Available FROM "+(new SimpleDateFormat("dd/MM/yyyy")).format(new Date())+" TO "+(new SimpleDateFormat("dd/MM/yyyy")).format(new Date())]]></variableExpression>
	</variable>
	<variable name="QtySum" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{issuedqty}]]></variableExpression>
	</variable>
	<variable name="ValueSum" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{amount}]]></variableExpression>
	</variable>
	<variable name="MachineGroupQty" class="java.math.BigDecimal" resetType="Group" resetGroup="Resource Name" calculation="Sum">
		<variableExpression><![CDATA[$F{issuedqty}]]></variableExpression>
	</variable>
	<variable name="MachinaryGroupoValue" class="java.math.BigDecimal" resetType="Group" resetGroup="Resource Name" calculation="Sum">
		<variableExpression><![CDATA[$F{amount}]]></variableExpression>
	</variable>
	<group name="Resource Name">
		<groupExpression><![CDATA[$F{machinname}]]></groupExpression>
		<groupHeader>
			<band/>
		</groupHeader>
		<groupFooter>
			<band height="27">
				<textField evaluationTime="Group" evaluationGroup="Resource Name" pattern="###0.00;###0.00-">
					<reportElement x="424" y="0" width="147" height="27"/>
					<box>
						<topPen lineWidth="0.25" lineStyle="Solid"/>
						<leftPen lineWidth="0.25" lineStyle="Solid"/>
						<bottomPen lineWidth="0.25" lineStyle="Solid"/>
						<rightPen lineWidth="0.25" lineStyle="Solid"/>
					</box>
					<textElement textAlignment="Right" verticalAlignment="Middle">
						<font isBold="true"/>
					</textElement>
					<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{MachinaryGroupoValue}.negate()]]></textFieldExpression>
				</textField>
				<textField evaluationTime="Group" evaluationGroup="Resource Name" pattern="###0;###0-">
					<reportElement x="294" y="0" width="130" height="27"/>
					<box>
						<topPen lineWidth="0.25" lineStyle="Solid"/>
						<leftPen lineWidth="0.25" lineStyle="Solid"/>
						<bottomPen lineWidth="0.25" lineStyle="Solid"/>
						<rightPen lineWidth="0.25" lineStyle="Solid"/>
					</box>
					<textElement textAlignment="Right" verticalAlignment="Middle">
						<font isBold="true"/>
					</textElement>
					<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{MachineGroupQty}.negate()]]></textFieldExpression>
				</textField>
				<staticText>
					<reportElement key="staticText-43" x="1" y="0" width="293" height="27"/>
					<box>
						<topPen lineWidth="0.25" lineStyle="Solid"/>
						<leftPen lineWidth="0.25" lineStyle="Solid"/>
						<bottomPen lineWidth="0.25" lineStyle="Solid"/>
						<rightPen lineWidth="0.25" lineStyle="Solid"/>
					</box>
					<textElement textAlignment="Right" verticalAlignment="Middle">
						<font size="10" isBold="true" pdfFontName="Helvetica-Bold"/>
					</textElement>
					<text><![CDATA[Machinery Wise Totals : ]]></text>
				</staticText>
			</band>
		</groupFooter>
	</group>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="102" splitType="Stretch">
			<staticText>
				<reportElement key="staticText-37" x="126" y="64" width="367" height="37"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="18" isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<text><![CDATA[Machinery Wise Consumption ]]></text>
			</staticText>
			<subreport>
				<reportElement x="2" y="4" width="638" height="60"/>
				<subreportParameter name="AD_Org_ID">
					<subreportParameterExpression><![CDATA[$P{AD_Org_ID}]]></subreportParameterExpression>
				</subreportParameter>
				<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
				<subreportExpression class="java.lang.String"><![CDATA[$P{SUBREPORT_DIR} + "clientaddress.jasper"]]></subreportExpression>
			</subreport>
		</band>
	</title>
	<pageHeader>
		<band height="40" splitType="Stretch">
			<textField isStretchWithOverflow="true" pattern="dd/MM/yyyy" isBlankWhenNull="true">
				<reportElement key="textField" x="56" y="24" width="100" height="15"/>
				<textElement>
					<font isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<textFieldExpression class="java.sql.Timestamp"><![CDATA[$P{FromDate}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement key="staticText-23" x="15" y="24" width="41" height="15"/>
				<textElement>
					<font isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<text><![CDATA[FROM]]></text>
			</staticText>
			<staticText>
				<reportElement key="staticText-24" x="174" y="24" width="27" height="13"/>
				<textElement>
					<font isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<text><![CDATA[TO]]></text>
			</staticText>
			<textField isStretchWithOverflow="true" pattern="dd/MM/yyyy" isBlankWhenNull="true">
				<reportElement key="textField" x="201" y="24" width="120" height="13"/>
				<textElement>
					<font isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<textFieldExpression class="java.sql.Timestamp"><![CDATA[$P{ToDate}]]></textFieldExpression>
			</textField>
		</band>
	</pageHeader>
	<columnHeader>
		<band height="23" splitType="Stretch">
			<staticText>
				<reportElement key="staticText-39" x="1" y="1" width="293" height="22"/>
				<box>
					<topPen lineWidth="0.25" lineStyle="Solid"/>
					<leftPen lineWidth="0.25" lineStyle="Solid"/>
					<bottomPen lineWidth="0.25" lineStyle="Solid"/>
					<rightPen lineWidth="0.25" lineStyle="Solid"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<text><![CDATA[MACHINE NAME]]></text>
			</staticText>
			<staticText>
				<reportElement key="staticText-41" x="294" y="1" width="130" height="22"/>
				<box>
					<topPen lineWidth="0.25" lineStyle="Solid"/>
					<leftPen lineWidth="0.25" lineStyle="Solid"/>
					<bottomPen lineWidth="0.25" lineStyle="Solid"/>
					<rightPen lineWidth="0.25" lineStyle="Solid"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<text><![CDATA[ISSUED QTY]]></text>
			</staticText>
			<staticText>
				<reportElement key="staticText-42" x="424" y="1" width="147" height="22"/>
				<box>
					<topPen lineWidth="0.25" lineStyle="Solid"/>
					<leftPen lineWidth="0.25" lineStyle="Solid"/>
					<bottomPen lineWidth="0.25" lineStyle="Solid"/>
					<rightPen lineWidth="0.25" lineStyle="Solid"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<text><![CDATA[VALUE]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="30" splitType="Stretch">
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement key="textField" x="1" y="0" width="293" height="30"/>
				<box>
					<topPen lineWidth="0.25" lineStyle="Solid"/>
					<leftPen lineWidth="0.25" lineStyle="Solid"/>
					<bottomPen lineWidth="0.25" lineStyle="Solid"/>
					<rightPen lineWidth="0.25" lineStyle="Solid"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{machinname}]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" pattern="###0" isBlankWhenNull="true">
				<reportElement key="textField" x="294" y="0" width="130" height="30"/>
				<box>
					<topPen lineWidth="0.25" lineStyle="Solid"/>
					<leftPen lineWidth="0.25" lineStyle="Solid"/>
					<bottomPen lineWidth="0.25" lineStyle="Solid"/>
					<rightPen lineWidth="0.25" lineStyle="Solid"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle"/>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{issuedqty}.negate()]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" pattern="##0.00" isBlankWhenNull="true">
				<reportElement key="textField" x="424" y="0" width="147" height="30"/>
				<box>
					<topPen lineWidth="0.25" lineStyle="Solid"/>
					<leftPen lineWidth="0.25" lineStyle="Solid"/>
					<bottomPen lineWidth="0.25" lineStyle="Solid"/>
					<rightPen lineWidth="0.25" lineStyle="Solid"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle"/>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{amount}.negate()]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band splitType="Stretch"/>
	</pageFooter>
	<summary>
		<band height="31" splitType="Stretch">
			<staticText>
				<reportElement key="staticText-43" x="1" y="0" width="293" height="31"/>
				<box>
					<topPen lineWidth="0.25" lineStyle="Solid"/>
					<leftPen lineWidth="0.25" lineStyle="Solid"/>
					<bottomPen lineWidth="0.25" lineStyle="Solid"/>
					<rightPen lineWidth="0.25" lineStyle="Solid"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="10" isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<text><![CDATA[Grand Totals : ]]></text>
			</staticText>
			<textField isStretchWithOverflow="true" pattern="###0" isBlankWhenNull="true">
				<reportElement key="textField" x="294" y="0" width="130" height="31"/>
				<box>
					<topPen lineWidth="0.25" lineStyle="Solid"/>
					<leftPen lineWidth="0.25" lineStyle="Solid"/>
					<bottomPen lineWidth="0.25" lineStyle="Solid"/>
					<rightPen lineWidth="0.25" lineStyle="Solid"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{QtySum}.negate()]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" pattern="##0.00" isBlankWhenNull="true">
				<reportElement key="textField" x="424" y="0" width="147" height="31"/>
				<box>
					<topPen lineWidth="0.25" lineStyle="Solid"/>
					<leftPen lineWidth="0.25" lineStyle="Solid"/>
					<bottomPen lineWidth="0.25" lineStyle="Solid"/>
					<rightPen lineWidth="0.25" lineStyle="Solid"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$V{ValueSum}.negate()]]></textFieldExpression>
			</textField>
		</band>
	</summary>
	<noData>
		<band height="48" splitType="Stretch">
			<staticText>
				<reportElement key="staticText-36" x="55" y="8" width="499" height="38"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="14" isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<text><![CDATA[  "DATA NOT AVAILABLE"]]></text>
			</staticText>
		</band>
	</noData>
</jasperReport>
